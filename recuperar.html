<!DOCTYPE html>
<html lang="pt-PT">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Bilhetes | Clube de Teatro</title>
    <link rel="stylesheet" href="index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Playfair+Display:ital,wght@0,700;1,700&display=swap"
        rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.1);
            --gold: #d4af37;
            --charcoal: #0f172a;
        }

        body {
            background: radial-gradient(circle at top right, #1e1b4b, #0f172a);
            color: #f8fafc;
            font-family: 'Outfit', sans-serif;
            min-height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
        }

        .recovery-wrapper {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .recovery-card {
            background: var(--glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 40px;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .recovery-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.2rem;
            margin-bottom: 10px;
            background: linear-gradient(to right, #fff, var(--gold));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .recovery-subtitle {
            color: #94a3b8;
            margin-bottom: 30px;
            font-weight: 300;
        }

        .step-container {
            transition: all 0.4s ease;
        }

        .hidden {
            display: none !important;
        }

        .form-group {
            margin-bottom: 25px;
            text-align: left;
        }

        .form-label {
            display: block;
            margin-bottom: 10px;
            font-size: 0.9rem;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            color: white;
            font-size: 1.1rem;
            transition: all 0.3s;
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--gold);
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
        }

        .btn-recover {
            width: 100%;
            padding: 16px;
            background: linear-gradient(45deg, #d4af37, #f59e0b);
            border: none;
            border-radius: 12px;
            color: #0f172a;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-recover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(212, 175, 55, 0.3);
            filter: brightness(1.1);
        }

        .btn-recover:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .ticket-list {
            margin-top: 30px;
            text-align: left;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .ticket-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: transform 0.3s;
        }

        .ticket-item h4 {
            margin: 0 0 5px 0;
            color: white;
            font-size: 1.1rem;
        }

        .ticket-item p {
            margin: 0;
            font-size: 0.85rem;
            color: #94a3b8;
        }

        .btn-dl {
            background: var(--gold);
            color: #0f172a;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .error-box {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .loading-dots:after {
            content: ' .';
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: ' .';
            }

            40% {
                content: ' . .';
            }

            60% {
                content: ' . . .';
            }

            80%,
            100% {
                content: '';
            }
        }
    </style>
</head>

<body>
    <!-- Theme Initializer -->
    <script>
        (function () {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
    <header class="header" style="background: transparent;">
        <div class="header__container"
            style="display: flex; align-items: center; justify-content: space-between; width: 100%; padding: 0 20px;">
            <a href="index.html" class="header__logo" style="color: white; font-family: 'Playfair Display', serif;">üé≠
                Clube de Teatro</a>
            <button onclick="toggleTheme()" class="btn-theme-toggle" id="themeToggleBtn" aria-label="Alterar Tema"
                style="background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.2); color: white;">üåì</button>
        </div>
    </header>

    <div class="recovery-wrapper">
        <div class="recovery-card">
            <h2 class="recovery-title">Recuperar Bilhetes</h2>
            <p class="recovery-subtitle">Introduz os teus dados para reencontrar as tuas reservas.</p>

            <div id="errorDisplay" class="error-box hidden"></div>

            <!-- STEP 1: Email -->
            <div id="step1" class="step-container">
                <div class="form-group">
                    <label class="form-label">Email da Reserva</label>
                    <input type="email" id="emailInput" class="form-input" placeholder="exemplo@email.com" autofocus>
                </div>
                <button onclick="handleStep1()" id="btnStep1" class="btn-recover">
                    Continuar <i class="fas fa-arrow-right"></i>
                </button>
            </div>

            <!-- STEP 2: Phone -->
            <div id="step2" class="step-container hidden">
                <div class="form-group">
                    <label class="form-label">Confirma o teu Telefone</label>
                    <input type="tel" id="phoneInput" class="form-input" placeholder="9xxxxxxxx">
                    <p style="font-size: 0.8rem; color: #94a3b8; margin-top: 10px;">
                        Por seguran√ßa, introduz o n√∫mero de telefone usado na reserva.
                    </p>
                </div>
                <button onclick="handleStep2()" id="btnStep2" class="btn-recover">
                    Validar e Ver Bilhetes <i class="fas fa-shield-alt"></i>
                </button>
                <button onclick="backToStep1()"
                    style="background:none; border:none; color:#94a3b8; margin-top:15px; cursor:pointer; font-size:0.9rem;">
                    <i class="fas fa-chevron-left"></i> Voltar
                </button>
            </div>

            <!-- STEP 3: Results -->
            <div id="step3" class="step-container hidden">
                <div id="ticketContainer" class="ticket-list"></div>
                <button onclick="location.reload()" class="btn-dl"
                    style="width:100%; margin-top:20px; background: rgba(255,255,255,0.1); color: white;">
                    Nova Procura
                </button>
            </div>
        </div>
    </div>

    <!-- Hidden element for QR generation -->
    <div id="qr-temp" style="display:none;"></div>

    <script src="firebase-config.js"></script>
    <script src="site-loader.js"></script>
    <script>
        let foundReservations = [];

        function showError(msg) {
            const err = document.getElementById('errorDisplay');
            err.textContent = msg;
            err.classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('errorDisplay').classList.add('hidden');
        }

        async function handleStep1() {
            const email = document.getElementById('emailInput').value.trim().toLowerCase();
            const btn = document.getElementById('btnStep1');

            if (!email) {
                showError('Por favor, introduz o teu email.');
                return;
            }

            hideError();
            btn.disabled = true;
            btn.innerHTML = 'A procurar<span class="loading-dots"></span>';

            try {
                // calls global getReservasByEmail from firebase-config.js
                foundReservations = await getReservasByEmail(email);

                if (foundReservations.length === 0) {
                    showError('N√£o encontramos nenhuma reserva para este email.');
                    btn.disabled = false;
                    btn.innerHTML = 'Continuar <i class="fas fa-arrow-right"></i>';
                    return;
                }

                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                document.getElementById('phoneInput').focus();

            } catch (e) {
                showError('Erro ao comunicar com o servidor.');
                console.error(e);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'Continuar <i class="fas fa-arrow-right"></i>';
            }
        }

        function backToStep1() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
            hideError();
        }

        async function handleStep2() {
            const phoneProvided = document.getElementById('phoneInput').value.trim().replace(/\s/g, '');
            const btn = document.getElementById('btnStep2');

            if (!phoneProvided) {
                showError('Por favor, introduz o teu telefone.');
                return;
            }

            hideError();
            btn.disabled = true;
            btn.innerHTML = 'A validar<span class="loading-dots"></span>';

            // Security: match ANY found reservation for that email with the phone
            const matches = foundReservations.filter(r => {
                const dbPhone = (r.telefone || r.telemovel || "").toString().trim().replace(/\s/g, '');
                return dbPhone === phoneProvided;
            });

            if (matches.length === 0) {
                showError('O n√∫mero de telefone n√£o coincide com os nossos registos.');
                btn.disabled = false;
                btn.innerHTML = 'Validar e Ver Bilhetes <i class="fas fa-shield-alt"></i>';
                return;
            }

            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step3').classList.remove('hidden');

            const container = document.getElementById('ticketContainer');
            container.innerHTML = `<p style="color:var(--gold); margin-bottom:15px; font-weight:600; text-align:left;">Encontramos ${matches.length} bilhete(s):</p>`;

            for (const r of matches) {
                const peca = await getPeca(r.pecaId);
                const isPaid = r.pagamentoStatus === 'pago' || r.pagamentoStatus === 'isento' || r.pagamentoStatus === 'bypassed';

                const item = document.createElement('div');
                item.className = 'ticket-item';
                item.innerHTML = `
                    <div style="flex:1; text-align:left;">
                        <h4 style="display:flex; align-items:center; gap:8px;">
                            ${peca ? peca.nome : 'Espet√°culo'}
                            ${isPaid ? '' : '<span style="font-size:0.6rem; background:#f59e0b; color:#0f172a; padding:2px 6px; border-radius:10px;">PENDENTE</span>'}
                        </h4>
                        <p style="font-family:monospace; letter-spacing:1px; margin-top:5px;">${r.codigoBilhete}</p>
                        <p style="font-size:0.75rem;">Lugar: ${r.fila}${r.lugar}</p>
                    </div>
                    ${isPaid ? `
                        <button onclick="downloadTicket('${r.id}')" class="btn-dl">
                            <i class="fas fa-download"></i> PDF
                        </button>
                    ` : `
                        <div style="opacity:0.3;"><i class="fas fa-lock"></i></div>
                    `}
                `;
                container.appendChild(item);
            }
        }

        async function downloadTicket(reservaId) {
            try {
                const res = foundReservations.find(r => r.id === reservaId);
                if (!res) return;
                const peca = await getPeca(res.pecaId);
                // generateTicketPDF is global from site-loader.js
                if (typeof generateTicketPDF === 'function') {
                    await generateTicketPDF([res], res.nomeReservante, peca);
                } else {
                    alert('Erro: Motor de PDF n√£o carregado.');
                }
            } catch (e) {
                console.error(e);
                alert('Erro ao gerar bilhete.');
            }
        }
    </script>
</body>

</html>